{"ast":null,"code":"import { asyncToGenerator as _asyncToGenerator } from './_virtual/_rollupPluginBabelHelpers.js';\nimport _regeneratorRuntime from 'regenerator-runtime';\nimport { AppConfig, UserSession } from '@stacks/auth';\nimport { decodeToken } from 'jsontokens';\nimport { getStacksProvider } from './utils.esm.js';\nvar defaultAuthURL = \"https://app.blockstack.org\";\nvar version = \"6.4.1\";\n\nif (typeof window !== \"undefined\") {\n  window.__CONNECT_VERSION__ = version;\n}\n\nvar isMobile = function isMobile() {\n  var ua = navigator.userAgent;\n\n  if (/android/i.test(ua)) {\n    return true;\n  }\n\n  if (/iPad|iPhone|iPod/.test(ua)) {\n    return true;\n  }\n\n  return /windows phone/i.test(ua);\n};\n\nvar shouldUsePopup = function shouldUsePopup() {\n  return !isMobile();\n};\n\nvar getOrCreateUserSession = function getOrCreateUserSession(userSession) {\n  if (!userSession) {\n    var appConfig = new AppConfig([\"store_write\"], document.location.href);\n    userSession = new UserSession({\n      appConfig: appConfig\n    });\n  }\n\n  return userSession;\n};\n\nvar authenticate = /*#__PURE__*/function () {\n  var _ref = /*#__PURE__*/_asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(authOptions) {\n    var provider, _authOptions$redirect, redirectTo, manifestPath, onFinish, onCancel, _authOptions$sendToSi, sendToSignIn, _userSession, appDetails, userSession, transitKey, authRequest, authResponse, token, payload, authResponsePayload;\n\n    return _regeneratorRuntime.wrap(function _callee$(_context) {\n      while (1) {\n        switch (_context.prev = _context.next) {\n          case 0:\n            provider = getStacksProvider();\n\n            if (provider) {\n              _context.next = 3;\n              break;\n            }\n\n            throw new Error(\"Unable to authenticate without Hiro Wallet extension\");\n\n          case 3:\n            _authOptions$redirect = authOptions.redirectTo, redirectTo = _authOptions$redirect === void 0 ? \"/\" : _authOptions$redirect, manifestPath = authOptions.manifestPath, onFinish = authOptions.onFinish, onCancel = authOptions.onCancel, _authOptions$sendToSi = authOptions.sendToSignIn, sendToSignIn = _authOptions$sendToSi === void 0 ? false : _authOptions$sendToSi, _userSession = authOptions.userSession, appDetails = authOptions.appDetails;\n            userSession = getOrCreateUserSession(_userSession);\n\n            if (userSession.isUserSignedIn()) {\n              userSession.signUserOut();\n            }\n\n            transitKey = userSession.generateAndStoreTransitKey();\n            authRequest = userSession.makeAuthRequest(transitKey, \"\" + document.location.origin + redirectTo, \"\" + document.location.origin + manifestPath, userSession.appConfig.scopes, void 0, void 0, {\n              sendToSignIn: sendToSignIn,\n              appDetails: appDetails,\n              connectVersion: version\n            });\n            _context.prev = 8;\n            _context.next = 11;\n            return provider.authenticationRequest(authRequest);\n\n          case 11:\n            authResponse = _context.sent;\n            _context.next = 14;\n            return userSession.handlePendingSignIn(authResponse);\n\n          case 14:\n            token = decodeToken(authResponse);\n            payload = token == null ? void 0 : token.payload;\n            authResponsePayload = payload;\n            onFinish == null ? void 0 : onFinish({\n              authResponse: authResponse,\n              authResponsePayload: authResponsePayload,\n              userSession: userSession\n            });\n            _context.next = 24;\n            break;\n\n          case 20:\n            _context.prev = 20;\n            _context.t0 = _context[\"catch\"](8);\n            console.error(\"[Connect] Error during auth request\", _context.t0);\n            onCancel == null ? void 0 : onCancel();\n\n          case 24:\n          case \"end\":\n            return _context.stop();\n        }\n      }\n    }, _callee, null, [[8, 20]]);\n  }));\n\n  return function authenticate(_x) {\n    return _ref.apply(this, arguments);\n  };\n}();\n\nvar getUserData = /*#__PURE__*/function () {\n  var _ref2 = /*#__PURE__*/_asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2(userSession) {\n    return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n      while (1) {\n        switch (_context2.prev = _context2.next) {\n          case 0:\n            userSession = getOrCreateUserSession(userSession);\n\n            if (!userSession.isUserSignedIn()) {\n              _context2.next = 3;\n              break;\n            }\n\n            return _context2.abrupt(\"return\", userSession.loadUserData());\n\n          case 3:\n            if (!userSession.isSignInPending()) {\n              _context2.next = 5;\n              break;\n            }\n\n            return _context2.abrupt(\"return\", userSession.handlePendingSignIn());\n\n          case 5:\n            return _context2.abrupt(\"return\", null);\n\n          case 6:\n          case \"end\":\n            return _context2.stop();\n        }\n      }\n    }, _callee2);\n  }));\n\n  return function getUserData(_x2) {\n    return _ref2.apply(this, arguments);\n  };\n}();\n\nexport { authenticate, defaultAuthURL, getOrCreateUserSession, getUserData, isMobile, shouldUsePopup };","map":{"version":3,"sources":["../src/auth.ts"],"names":["defaultAuthURL","version","__CONNECT_VERSION__","isMobile","ua","navigator","userAgent","shouldUsePopup","getOrCreateUserSession","userSession","appConfig","document","authenticate","provider","getStacksProvider","redirectTo","manifestPath","onFinish","onCancel","sendToSignIn","_userSession","appDetails","authOptions","signUserOut","transitKey","authRequest","connectVersion","authResponse","token","decodeToken","payload","authResponsePayload","error","getUserData"],"mappings":"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","sourcesContent":["import { AppConfig, UserSession } from '@stacks/auth';\nimport { decodeToken } from 'jsontokens';\nimport type { AuthOptions, AuthResponsePayload } from './types';\n\nimport { getStacksProvider } from './utils';\n\nexport const defaultAuthURL = 'https://app.blockstack.org';\n\nconst version = __VERSION__;\n\nif (typeof window !== 'undefined') {\n  window.__CONNECT_VERSION__ = version;\n}\n\nexport const isMobile = () => {\n  const ua = navigator.userAgent;\n  if (/android/i.test(ua)) {\n    return true;\n  }\n  if (/iPad|iPhone|iPod/.test(ua)) {\n    return true;\n  }\n  return /windows phone/i.test(ua);\n};\n\n/**\n * mobile should not use a 'popup' type of window.\n */\nexport const shouldUsePopup = () => {\n  return !isMobile();\n};\n\nexport const getOrCreateUserSession = (userSession?: UserSession): UserSession => {\n  if (!userSession) {\n    const appConfig = new AppConfig(['store_write'], document.location.href);\n    userSession = new UserSession({ appConfig });\n  }\n  return userSession;\n};\n\nexport const authenticate = async (authOptions: AuthOptions) => {\n  const provider = getStacksProvider();\n  if (!provider) {\n    throw new Error('Unable to authenticate without Hiro Wallet extension');\n  }\n\n  const {\n    redirectTo = '/',\n    manifestPath,\n    onFinish,\n    onCancel,\n    sendToSignIn = false,\n    userSession: _userSession,\n    appDetails,\n  } = authOptions;\n  const userSession = getOrCreateUserSession(_userSession);\n  if (userSession.isUserSignedIn()) {\n    userSession.signUserOut();\n  }\n  const transitKey = userSession.generateAndStoreTransitKey();\n  const authRequest = userSession.makeAuthRequest(\n    transitKey,\n    `${document.location.origin}${redirectTo}`,\n    `${document.location.origin}${manifestPath}`,\n    userSession.appConfig.scopes,\n    undefined,\n    undefined,\n    {\n      sendToSignIn,\n      appDetails,\n      connectVersion: version,\n    }\n  );\n\n  try {\n    const authResponse = await provider.authenticationRequest(authRequest);\n    await userSession.handlePendingSignIn(authResponse);\n    const token = decodeToken(authResponse);\n    const payload = token?.payload;\n    const authResponsePayload = payload as unknown as AuthResponsePayload;\n    onFinish?.({\n      authResponse,\n      authResponsePayload,\n      userSession,\n    });\n  } catch (error) {\n    console.error('[Connect] Error during auth request', error);\n    onCancel?.();\n  }\n};\n\nexport const getUserData = async (userSession?: UserSession) => {\n  userSession = getOrCreateUserSession(userSession);\n  if (userSession.isUserSignedIn()) {\n    return userSession.loadUserData();\n  }\n  if (userSession.isSignInPending()) {\n    return userSession.handlePendingSignIn();\n  }\n  return null;\n};\n"]},"metadata":{},"sourceType":"module"}